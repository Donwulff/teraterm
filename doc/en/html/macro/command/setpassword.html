<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <title>setpassword</title>
  <meta http-equiv="Content-Style-Type" content="text/css">
  <link rel="stylesheet" href="../../style.css" type="text/css">
</head>

<body>


<h1>setpassword</h1>

<p>
Adds or Overwrites a password. <em>(version 4.75 or later)</em>
</p>

<h2>Format</h2>

<pre class="macro-syntax">
setpassword &lt;filename&gt; &lt;password name&gt; &lt;strval&gt; [&lt;encryptstr&gt;]
</pre>

<h2>Remarks</h2>

<p>
A password identified by &lt;password name&gt; from the password file &lt;filename&gt; is updated.<br>
The string &lt;strval&gt; is obfuscated and stored into the file.
</p>

<p>
If the specified file does not exist, it is newly created.<br>
</p>

<p>
A password file can contain multiple passwords.<br>
Each of them is identified by the password identifier.
</p>

<p>
When the password file can not be written, the system variable "result" is set to 0. Otherwise, "result" is set to 1.
</p>

<dl>
 <dt class="macro">(version X.XX or later)</dt>
 <dd> If &lt;encryptstr&gt; is specified, &lt;strval&gt; is encrypted using &lt;encryptstr&gt;.<br>
      The encrypted string is the base64 encoded of the following.
 <table border=1>
  <tbody>
   <tr class="td ">
    <th>Item</th>
    <th>Length</th>
    <th>Meaning</th>
   </tr>
   <tr>
    <td>prefix</td>
    <td>8</td>
    <td>"Salted__"</td>
   </tr>
   <tr>
    <td>salt</td>
    <td>8</td>
    <td>RAND_bytes()</td>
   </tr>
   <tr>
    <td rowspan="3">String encrypted below<br>
      EVP_aes_256_ctr()<br>
      KDF:PKCS5_PBKDF2_HMAC()<br>
      hash:EVP_sha256()<br>
      iteration count:10000<br>
    </td>
    <td>300</td>
    <td>&lt;strval&gt;<br>
      NULL padding for parts less than 300 characters<br>
    </td>
   </tr>
   <tr>
    <td>1</td>
    <td>NULL</td>
   </tr>
   <tr>
    <td>64</td>
    <td>SHA512() hash of &lt;encryptstr&gt;
    </td>
   </tr>
  </tbody>
 </table>
 <br>
 <dd>Encryption is equivalent to the following
 <pre class="macro-syntax">
password_name="user01"
strval="password_XXX"
encryptstr="encryptstr_XXX"

openssl rand -out salt.raw 8
salthex=`xxd -g 0 salt.raw | awk '{print $2}'`
(
  echo -n "${encryptstr}"
  cat salt.raw
) | openssl sha512 -out hash.raw -binary

echo -ne "${password_name}="
(
  echo -n "Salted__"
  cat salt.raw
  (
    echo -n "${strval}" | dd conv=sync bs=300 count=1 status=none
    echo -ne '\x00'
    cat hash.raw
  ) | openssl enc -e -aes-256-ctr -md sha256 -pbkdf2 -S ${salthex} -iter 10000 -pass "pass:${encryptstr}"
) | openssl base64 -a -A
echo ""
 </pre>
 </dd>
 <dd>Decryption is equivalent to the following
 <pre class="macro-syntax">
str='user01=U2FsdGVkX1+9o8OmOGN+clZRNELxWixbAXsGJIYB8oosd2pLp+FHLonyUOiEkLBHMkxH6Q0PzrCWFyBtioaoui1Wk/+rcqeDsLxNBv3Lxhc0DTJplAsNbtJ43K5kUZfOrdWoWFDqkPkmEN5dssWHcxsfOPOFlMJHs527cWdCLY7sTYzMgcYKBHJ3tZHtxqP6f54z3/89O2mkXXVSbKijLUMqlg1SKALJdwDu38LNl5gpjPQZReK6gQO3de1M4XMpTAomO8ZAGfV9ZNBFDsf3lTx4PbNXct8zj2bfKAkUjuh3MjLSuHJ79+ge3IGw+ltxLR224OdnbMmT3qpuEkctrVkP6/0IRF+rED80QdxzO9tyIh9sFSDNr6k+Z7bLzE3Qe6hMvGpuaHjce4m78E/GjjHa+vppqoJ5FkZYsyGhVu9V3AAlx74hsCvAtvg9FYl5XmlqlCe+JwM28Mo1Ndu8kApumrgiNo6tyZiZIcKSdhF8+Uc2OX1Gv/dRVocQ'

encryptstr="encryptstr_XXX"

echo -n "password_name="
echo ${str} | cut -d= -f1

echo -n "strval="
echo ${str} | cut -d= -f2 | openssl enc -d -aes-256-ctr -md sha256 -pbkdf2 -iter 10000 -pass "pass:${encryptstr}" -a -A | awk 'BEGIN{FS="\x00"}{print $1;exit}'
 </pre>
</dl>

<h2>Example</h2>

<pre class="macro-example">
newpasswd = 'hoge'
<strong>setpassword</strong> 'password.dat' 'yutaka' newpasswd
if result then
  messagebox 'Password updated successfully.' 'Result'
endif
</pre>

<h2>See also</h2>
<ul>
  <li><a href="getpassword.html">getpassword</a></li>
  <li><a href="ispassword.html">ispassword</a></li>
</ul>

</BODY>
</HTML>
